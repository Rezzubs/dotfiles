#!/usr/bin/python
import subprocess as sb

BLACKLIST = {"C01U"}


def is_allowed(x):
    return all([pattern not in x for pattern in BLACKLIST])


def main():
    status = sb.run(["wpctl", "status"], stdout=sb.PIPE).stdout.decode()
    status = "\n".join([line[4:]
                       for line in status.splitlines() if is_allowed(line)])

    start = None
    end = None
    for i, line in enumerate(status.splitlines()):
        if "Sinks:" in line and start is None:
            start = i + 1

        if start is not None and end is None and line.strip() == "":
            end = i
    assert start is not None and end is not None

    sinks = status.splitlines()[start:end]

    ids = []
    default = None
    for i, sink in enumerate(sinks):
        split = sink.split()
        if split[0] == "*":
            ids.append(int(split[1][:-1]))
            default = i
        else:
            ids.append(int(split[0][:-1]))

    try:
        assert default is not None
        new = ids[default + 1]
    except (IndexError, AssertionError):
        new = ids[0]

    print(f"switching to sink {new}")
    sb.run(["wpctl", "set-default", str(new)])


if __name__ == "__main__":
    main()
